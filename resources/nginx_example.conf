# OTPdoor Nginx Configuration Example (Multi-Domain)

# 1. Define the internal auth server
upstream otpdoor_backend {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name myapp.example.com;

    # 2. Main location to protect
    location / {
        # Check authentication for the 'myapp' domain
        auth_request /_check;
        
        # Redirect to auth page if 401 Unauthorized
        error_page 401 = @error401;

        proxy_pass http://my_actual_app;
    }

    # 3. Auth check endpoint
    location = /_check {
        internal;
        # Pass domain=myapp to use the correct TOTP secret and settings
        proxy_pass http://otpdoor_backend/_check?domain=myapp;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }

    # 4. Auth login endpoints
    location /_auth {
        # Pass domain=myapp to use the correct theme and settings on the login page
        proxy_pass http://otpdoor_backend/_auth?domain=myapp;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 5. Named location for unauthorized redirect
    location @error401 {
        # Redirect to login page with domain and originator (return URL)
        return 302 $scheme://$http_host/_auth?domain=myapp&originator=$request_uri;
    }
}
